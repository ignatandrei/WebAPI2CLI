<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Blockly swagger demo</title>
    <script src="/blockly/acorn_interpreter.js"></script>
    <script src="/blockly/blockly_compressed.js"></script>
    <script src="/blockly/blocks_compressed.js"></script>
    <script src="/blockly/javascript_compressed.js"></script>
    <script src="/blockly/en.js"></script>
    <script src="/blockly/wait_block.js"></script>
    <style>
        body {
            background-color: #fff;
            font-family: sans-serif;
        }

        h1 {
            font-weight: normal;
            font-size: 140%;
        }
    </style>
</head>
<body>
    <h1>
        Blockly Swagger
    </h1>
    <script src="/blocklyDefinitions"></script>
    <script src="/BlocklyToolBoxValueDefinitions"></script>
    <script src="/blocklyAPIFunctions"></script>
    <script src="/BlocklyToolBoxFunctionDefinitions"></script>

    <p>
        <button onclick="runCode()" id="runButton">Run!</button>
    </p>

    <div style="width: 100%">
        <div id="blocklyDiv"
             style="display: inline-block; height: 480px; width: 58%"></div>
        <textarea id="output" disabled="disabled"
                  style="display: inline-block; height: 480px; width: 38%;">
    </textarea>
    </div>

    <xml id="toolbox" style="display: none">
        <category name="LocalSite">
            <category custom="LocalSiteValues" colour="160" name="LocalSiteValues">
            </category>
            <category id="LocalSiteFunctions" name="LocalSiteFunctions">
            </category>

        </category>
        <sep></sep>
        <category name="Core">
            <block type="api_MyTest_AddValues_POST">
                <value name="val_sumargs">
                    <shadow type="TestWebAPISite_Controllers_SumArgs">
                        <value name="val_x">
                            <shadow type="math_number">
                                <field name="NUM">10</field>
                            </shadow>
                        </value>
                    </shadow>
                </value>
            </block>
            <block type="api_MathAdd_POST">
                <value name="val_value"><shadow type="text"><field name="TEXT">abc</field></shadow></value>
            </block>
            <block type="TestWebAPISite_Controllers_SumArgs">
                <value name="val_x">
                    <shadow type="math_number">
                        <field name="NUM">10</field>
                    </shadow>
                </value>
            </block>


            <category id="catLogic" colour="210" name="Logic">
                <block type="controls_if"></block>
                <block type="logic_compare"></block>
                <block type="logic_operation"></block>
                <block type="logic_negate"></block>
                <block type="logic_boolean"></block>
                <block type="logic_null"></block>
                <block type="logic_ternary"></block>
            </category>
            <category id="catLoops" colour="120" name="Loops">
                <block type="controls_repeat_ext">
                    <value name="TIMES">
                        <shadow type="math_number">
                            <field name="NUM">10</field>
                        </shadow>
                    </value>
                </block>
                <block type="controls_whileUntil"></block>
                <block type="controls_for">
                    <value name="FROM">
                        <shadow type="math_number">
                            <field name="NUM">1</field>
                        </shadow>
                    </value>
                    <value name="TO">
                        <shadow type="math_number">
                            <field name="NUM">10</field>
                        </shadow>
                    </value>
                    <value name="BY">
                        <shadow type="math_number">
                            <field name="NUM">1</field>
                        </shadow>
                    </value>
                </block>
                <block type="controls_forEach"></block>
                <block type="controls_flow_statements"></block>
            </category>
            <category id="catMath" colour="230" name="Math">
                <block type="math_number"></block>
                <block type="math_arithmetic">
                    <value name="A">
                        <shadow type="math_number">
                            <field name="NUM">1</field>
                        </shadow>
                    </value>
                    <value name="B">
                        <shadow type="math_number">
                            <field name="NUM">1</field>
                        </shadow>
                    </value>
                </block>
                <block type="math_single">
                    <value name="NUM">
                        <shadow type="math_number">
                            <field name="NUM">9</field>
                        </shadow>
                    </value>
                </block>
                <block type="math_trig">
                    <value name="NUM">
                        <shadow type="math_number">
                            <field name="NUM">45</field>
                        </shadow>
                    </value>
                </block>
                <block type="math_constant"></block>
                <block type="math_number_property">
                    <value name="NUMBER_TO_CHECK">
                        <shadow type="math_number">
                            <field name="NUM">0</field>
                        </shadow>
                    </value>
                </block>
                <block type="math_change">
                    <value name="DELTA">
                        <shadow type="math_number">
                            <field name="NUM">1</field>
                        </shadow>
                    </value>
                </block>
                <block type="math_round">
                    <value name="NUM">
                        <shadow type="math_number">
                            <field name="NUM">3.1</field>
                        </shadow>
                    </value>
                </block>
                <block type="math_on_list"></block>
                <block type="math_modulo">
                    <value name="DIVIDEND">
                        <shadow type="math_number">
                            <field name="NUM">64</field>
                        </shadow>
                    </value>
                    <value name="DIVISOR">
                        <shadow type="math_number">
                            <field name="NUM">10</field>
                        </shadow>
                    </value>
                </block>
                <block type="math_constrain">
                    <value name="VALUE">
                        <shadow type="math_number">
                            <field name="NUM">50</field>
                        </shadow>
                    </value>
                    <value name="LOW">
                        <shadow type="math_number">
                            <field name="NUM">1</field>
                        </shadow>
                    </value>
                    <value name="HIGH">
                        <shadow type="math_number">
                            <field name="NUM">100</field>
                        </shadow>
                    </value>
                </block>
                <block type="math_random_int">
                    <value name="FROM">
                        <shadow type="math_number">
                            <field name="NUM">1</field>
                        </shadow>
                    </value>
                    <value name="TO">
                        <shadow type="math_number">
                            <field name="NUM">100</field>
                        </shadow>
                    </value>
                </block>
                <block type="math_random_float"></block>
            </category>
            <category id="catText" colour="160" name="Text">
                <block type="text"></block>
                <block type="text_join"></block>
                <block type="text_append">
                    <value name="TEXT">
                        <shadow type="text"></shadow>
                    </value>
                </block>
                <block type="text_length">
                    <value name="VALUE">
                        <shadow type="text">
                            <field name="TEXT">abc</field>
                        </shadow>
                    </value>
                </block>
                <block type="text_isEmpty">
                    <value name="VALUE">
                        <shadow type="text">
                            <field name="TEXT"></field>
                        </shadow>
                    </value>
                </block>
                <block type="text_indexOf">
                    <value name="VALUE">
                        <block type="variables_get">
                            <field name="VAR">text</field>
                        </block>
                    </value>
                    <value name="FIND">
                        <shadow type="text">
                            <field name="TEXT">abc</field>
                        </shadow>
                    </value>
                </block>
                <block type="text_charAt">
                    <value name="VALUE">
                        <block type="variables_get">
                            <field name="VAR">text</field>
                        </block>
                    </value>
                </block>
                <block type="text_getSubstring">
                    <value name="STRING">
                        <block type="variables_get">
                            <field name="VAR">text</field>
                        </block>
                    </value>
                </block>
                <block type="text_changeCase">
                    <value name="TEXT">
                        <shadow type="text">
                            <field name="TEXT">abc</field>
                        </shadow>
                    </value>
                </block>
                <block type="text_trim">
                    <value name="TEXT">
                        <shadow type="text">
                            <field name="TEXT">abc</field>
                        </shadow>
                    </value>
                </block>
                <block type="text_print">
                    <value name="TEXT">
                        <shadow type="text">
                            <field name="TEXT">abc</field>
                        </shadow>
                    </value>
                </block>
                <block type="text_prompt_ext">
                    <value name="TEXT">
                        <shadow type="text">
                            <field name="TEXT">abc</field>
                        </shadow>
                    </value>
                </block>
            </category>
            <category id="catLists" colour="260" name="Lists">
                <block type="lists_create_with">
                    <mutation items="0"></mutation>
                </block>
                <block type="lists_create_with"></block>
                <block type="lists_repeat">
                    <value name="NUM">
                        <shadow type="math_number">
                            <field name="NUM">5</field>
                        </shadow>
                    </value>
                </block>
                <block type="lists_length"></block>
                <block type="lists_isEmpty"></block>
                <block type="lists_indexOf">
                    <value name="VALUE">
                        <block type="variables_get">
                            <field name="VAR">list</field>
                        </block>
                    </value>
                </block>
                <block type="lists_getIndex">
                    <value name="VALUE">
                        <block type="variables_get">
                            <field name="VAR">list</field>
                        </block>
                    </value>
                </block>
                <block type="lists_setIndex">
                    <value name="LIST">
                        <block type="variables_get">
                            <field name="VAR">list</field>
                        </block>
                    </value>
                </block>
                <block type="lists_getSublist">
                    <value name="LIST">
                        <block type="variables_get">
                            <field name="VAR">list</field>
                        </block>
                    </value>
                </block>
                <block type="lists_split">
                    <value name="DELIM">
                        <shadow type="text">
                            <field name="TEXT">,</field>
                        </shadow>
                    </value>
                </block>
                <block type="lists_sort"></block>
            </category>
            <category id="catColour" colour="20" name="Color">
                <block type="colour_picker"></block>
                <block type="colour_random"></block>
                <block type="colour_rgb">
                    <value name="RED">
                        <shadow type="math_number">
                            <field name="NUM">100</field>
                        </shadow>
                    </value>
                    <value name="GREEN">
                        <shadow type="math_number">
                            <field name="NUM">50</field>
                        </shadow>
                    </value>
                    <value name="BLUE">
                        <shadow type="math_number">
                            <field name="NUM">0</field>
                        </shadow>
                    </value>
                </block>
                <block type="colour_blend">
                    <value name="COLOUR1">
                        <shadow type="colour_picker">
                            <field name="COLOUR">#ff0000</field>
                        </shadow>
                    </value>
                    <value name="COLOUR2">
                        <shadow type="colour_picker">
                            <field name="COLOUR">#3333ff</field>
                        </shadow>
                    </value>
                    <value name="RATIO">
                        <shadow type="math_number">
                            <field name="NUM">0.5</field>
                        </shadow>
                    </value>
                </block>
            </category>
        </category>
        <sep></sep>
        <category name="advanced">
            <category id="catVariables" colour="330" custom="VARIABLE" name="Variables"></category>
            <category id="catFunctions" colour="290" custom="PROCEDURE" name="Functions"></category>
            <category id="catHelpers" colour="160" name="Helpers">
                <block type="wait_seconds"></block>
                <block type="text_print">
                    <value name="TEXT">
                        <shadow type="text">
                            <field name="TEXT">abc</field>
                        </shadow>
                    </value>
                </block>
                <block type="text_prompt_ext">
                    <value name="TEXT">
                        <shadow type="text">
                            <field name="TEXT">abc</field>
                        </shadow>
                    </value>
                </block>
            </category>
        </category>

    </xml>

    <xml xmlns="https://developers.google.com/blockly/xml" id="startBlocks" style="display: none">
        <block type="variables_set" id="set_n_initial" inline="true" x="20" y="20">
            <field name="VAR">n</field>
            <value name="VALUE">
                <block type="math_number">
                    <field name="NUM">1</field>
                </block>
            </value>
            <next>

                <block type="controls_repeat_ext" id="repeat" inline="true">
                    <value name="TIMES">
                        <block type="math_number">
                            <field name="NUM">2</field>
                        </block>
                    </value>

                    <statement name="DO">
                        <block type="wait_seconds" id="wait">
                            <field name="SECONDS">1.0</field>
                            <next>
                                <block type="variables_set" id="set_n_update" inline="true">
                                    <field name="VAR">n</field>
                                    <value name="VALUE">
                                        <block type="math_arithmetic" inline="true">
                                            <field name="OP">MULTIPLY</field>
                                            <value name="A">
                                                <block type="variables_get">
                                                    <field name="VAR">n</field>
                                                </block>
                                            </value>
                                            <value name="B">
                                                <block type="math_number">
                                                    <field name="NUM">2</field>
                                                </block>
                                            </value>
                                        </block>
                                    </value>
                                    <next>
                                        <block type="text_print" id="print1" inline="false">
                                            <value name="TEXT">
                                                <block type="api_MyTest_AddValues_POST">
                                                    <value name="val_sumargs">
                                                        <block type="TestWebAPISite_Controllers_SumArgs">
                                                            <value name="val_x">
                                                                <shadow type="math_number">
                                                                    <field name="NUM">10</field>
                                                                </shadow>
                                                            </value>
                                                            <value name="val_y">
                                                                <block type="variables_get">
                                                                    <field name="VAR">n</field>
                                                                </block>
                                                            </value>

                                                        </block>
                                                    </value>
                                                </block>

                                            </value>
                                            <next>
                                                <block type="text_print" id="print2" inline="false">
                                                    <value name="TEXT">
                                                        <block type="api_MathAdd_GET"></block>
                                                    </value>
                                                    <next>
                                                        <block type="text_print" id="print3" inline="false">
                                                            <value name="TEXT">
                                                                <block type="api_MathAdd__id__GET">
                                                                    <value name="val_id">
                                                                        <block type="variables_get">
                                                                            <field name="VAR">n</field>
                                                                        </block>

                                                                    </value>
                                                                </block>
                                                            </value>
                                                            <next>
                                                                <block type="text_print" id="print3" inline="false">
                                                                    <value name="TEXT">

                                                                        <block type="api_MathAdd_POST">
                                                                            <value name="val_value"><shadow type="text"><field name="TEXT">abc</field></shadow></value>
                                                                        </block>
                                                                    </value>
                                                                    <next>
                                                                        <block type="text_print" id="print3" inline="false">
                                                                            <value name="TEXT">

                                                                                <block type="api_MathAdd__id__PUT">
                                                                                    <value name="val_value"><shadow type="text"><field name="TEXT">abc</field></shadow></value>
                                                                                    <value name="val_id">
                                                                                        <block type="variables_get">
                                                                                            <field name="VAR">n</field>
                                                                                        </block>

                                                                                    </value>
                                                                                </block>
                                                                            </value>
                                                                            <next>
                                                                                <block type="text_print" id="print3" inline="false">
                                                                                    <value name="TEXT">

                                                                                        <block type="api_MathAdd__id__DELETE">                                                                                            
                                                                                            <value name="val_id">
                                                                                                <block type="variables_get">
                                                                                                    <field name="VAR">n</field>
                                                                                                </block>

                                                                                            </value>
                                                                                        </block>
                                                                                    </value>
                                                                                    <next>
                                                                                        <block type="text_print" id="print3" inline="false">
                                                                                            <value name="TEXT">
                                                                                                <block type="WeatherForecast_GET">
                                                                                                </block>
                                                                                            </value>
                                                                                        </block>
                                                                                    </next>
                                                                                </block>
                                                                            </next>
                                                                        </block>

                                                                    </next>
                                                                </block>

                                                            </next>
                                                        </block>
                                                    </next>

                                                </block>

                                            </next>

                                        </block>

                                    </next>
                                </block>
                            </next>
                        </block>
                    </statement>
                </block>
            </next>
        </block>
    </xml>

    <script>
        var test = document.getElementById("LocalSiteFunctions");
        //console.log(blockTextLocalSiteFunctions);
        test.innerHTML = blockTextLocalSiteFunctions;
        demoWorkspace = Blockly.inject('blocklyDiv',
            {
                media: '../../media/',
                toolbox: document.getElementById('toolbox')
            });
        demoWorkspace.registerToolboxCategoryCallback('LocalSiteValues', registerValues);
        //demoWorkspace.registerToolboxCategoryCallback('LocalSiteFunctions', registerFunctions);
        //function (ws) {
        //    //var tb = ws.getToolbox();
        //    //console.log(tb);
        //    //window.alert('adsa');
        //    registerFunctions();
        //    //var tb = demoWorkspace.getToolbox();
        //    //tb.refreshSelection();
        //});

        Blockly.Xml.domToWorkspace(document.getElementById('startBlocks'), demoWorkspace);
        //var tb = demoWorkspace.getToolbox();
        //console.log(tb.tree_);
        //tb.refreshSelection();
        //demoWorkspace.updateToolbox(tb);

        // Exit is used to signal the end of a script.
        Blockly.JavaScript.addReservedWords('exit');

        var outputArea = document.getElementById('output');
        var runButton = document.getElementById('runButton');
        var myInterpreter = null;
        var runner;

        function initApi(interpreter, globalObject) {
            // Add an API function for the alert() block, generated for "text_print" blocks.
            var wrapper = function (text) {
                text = text ? text.toString() : '';
                console.log(JSON.stringify(text));
                outputArea.value = outputArea.value + '\n' + text;
            };
            interpreter.setProperty(globalObject, 'alert',
                interpreter.createNativeFunction(wrapper));

            // Add an API function for the prompt() block.
            var wrapper = function (text) {
                text = text ? text.toString() : '';
                return interpreter.createPrimitive(prompt(text));
            };
            interpreter.setProperty(globalObject, 'prompt',
                interpreter.createNativeFunction(wrapper));
                //var wrapper = function (obj) {
                //    var json = JSON.parse(obj);
                //    var objNew = {};
                //    console.log(Blockly.mainWorkspace.getAllVariables());
                //    for (var key in json) {
                //        console.log(`evaluating ${key}`);
                //        objNew[key] = eval(json[key]);
                //        console.log(`finish ${key}`);
                //    }
                //    return objNew;
                //}
                //interpreter.setProperty(globalObject, 'resolveObject',
                //    interpreter.createNativeFunction(wrapper));

            var wrapper = function (href, callback) {
                var req = new XMLHttpRequest();
                req.open('GET', href, true);
                req.onreadystatechange = function () {
                    if (req.readyState == 4) {
                        if (req.status == 200) {
                            callback(req.responseText);
                        } else {
                            throw `${href} status :${req.status}`;
                        }

                    }
                    else {
                        //window.alert(`error ${href} ${req.status}`);
                    }
                };
                req.send(null);
            };
            interpreter.setProperty(globalObject, 'getXhr',
                interpreter.createAsyncFunction(wrapper));



            var wrapper = function (href, objectToPost, callback) {
                var data = `postXhr: href: ${href} obj: ${objectToPost}`;
                //console.log(data);
                //data = JSON.stringify(objectToPost);
                data = objectToPost;
                //console.log(`sending ${data}`);
                var req = new XMLHttpRequest();

                req.open('POST', href, true);
                req.setRequestHeader("Content-Type", "application/json;charset=UTF-8");

                req.onreadystatechange = function () {
                    if (req.readyState == 4) {
                        if (req.status == 200) {
                            var answer = req.responseText;
                            if (answer) {
                                callback(answer);
                            }
                            else {
                                callback(true);
                            }
                        } else {
                            throw `${href} status :${req.status}`;
                        }

                    }
                    else {
                        //window.alert(`error ${href} ${req.status}`);
                    }
                };
                req.send(data);
            };
            interpreter.setProperty(globalObject, 'postXhr',
                interpreter.createAsyncFunction(wrapper));

            var wrapper = function (href, objectToPost, callback) {
                var data = `putXhr: href: ${href} obj: ${objectToPost}`;
                //console.log(data);
                //data = JSON.stringify(objectToPost);
                data = objectToPost;
                //console.log(`sending ${data}`);
                var req = new XMLHttpRequest();

                req.open('PUT', href, true);
                req.setRequestHeader("Content-Type", "application/json;charset=UTF-8");

                req.onreadystatechange = function () {
                    if (req.readyState == 4) {
                        if (req.status == 200) {
                            var answer = req.responseText;
                            if (answer) {
                                callback(answer);
                            }
                            else {
                                callback(true);
                            }
                        } else {
                            throw `${href} status :${req.status}`;
                        }

                    }
                    else {
                        //window.alert(`error ${href} ${req.status}`);
                    }
                };
                req.send(data);
            };
            interpreter.setProperty(globalObject, 'putXhr',
                interpreter.createAsyncFunction(wrapper));


            var wrapper = function (href, callback) {
                var data = `deleteXhr: href: ${href} `;
                //console.log(data);
                
                
                var req = new XMLHttpRequest();

                req.open('DELETE', href, true);
                req.setRequestHeader("Content-Type", "application/json;charset=UTF-8");

                req.onreadystatechange = function () {
                    if (req.readyState == 4) {
                        if (req.status == 200) {
                            var answer = req.responseText;
                            if (answer) {
                                callback(answer);
                            }
                            else {
                                callback(true);
                            }
                        } else {
                            throw `${href} status :${req.status}`;
                        }

                    }
                    else {
                        //window.alert(`error ${href} ${req.status}`);
                    }
                };
                req.send(null);
            };
            interpreter.setProperty(globalObject, 'deleteXhr',
                interpreter.createAsyncFunction(wrapper));


            // Add an API for the wait block.  See wait_block.js
            initInterpreterWaitForSeconds(interpreter, globalObject);

            // Add an API function for highlighting blocks.
            var wrapper = function (id) {
                id = id ? id.toString() : '';
                return interpreter.createPrimitive(highlightBlock(id));
            };
            interpreter.setProperty(globalObject, 'highlightBlock',
                interpreter.createNativeFunction(wrapper));
        }

        var highlightPause = false;
        var latestCode = '';

        function highlightBlock(id) {
            demoWorkspace.highlightBlock(id);
            highlightPause = true;
        }

        function resetStepUi(clearOutput) {
            demoWorkspace.highlightBlock(null);
            highlightPause = false;
            runButton.disabled = '';

            if (clearOutput) {
                outputArea.value = 'Program output:\n=================';
            }
        }

        function generateCodeAndLoadIntoInterpreter() {
            // Generate JavaScript code and parse it.
            Blockly.JavaScript.STATEMENT_PREFIX = 'highlightBlock(%1);\n';
            Blockly.JavaScript.addReservedWords('highlightBlock');
            latestCode = Blockly.JavaScript.workspaceToCode(demoWorkspace);

            resetStepUi(true);
        }

        function resetInterpreter() {
            myInterpreter = null;
            if (runner) {
                clearTimeout(runner);
                runner = null;
            }
        }

        function runCode() {
            if (!myInterpreter) {
                // First statement of this code.
                // Clear the program output.
                resetStepUi(true);
                runButton.disabled = 'disabled';

                // And then show generated code in an alert.
                // In a timeout to allow the outputArea.value to reset first.
                setTimeout(function () {
                    console.log(latestCode);
                    //alert('Ready to execute the following code\n' +
                    //    '===================================\n' +
                    //    latestCode);

                    // Begin execution
                    highlightPause = false;
                    myInterpreter = new Interpreter(latestCode, initApi);
                    runner = function () {
                        if (myInterpreter) {
                            var hasMore = myInterpreter.run();
                            if (hasMore) {
                                // Execution is currently blocked by some async call.
                                // Try again later.
                                setTimeout(runner, 10);
                            } else {
                                // Program is complete.
                                outputArea.value += '\n\n<< Program complete >>';
                                resetInterpreter();
                                resetStepUi(false);
                            }
                        }
                    };
                    runner();
                }, 1);
                return;
            }
        }

        // Load the interpreter now, and upon future changes.
        generateCodeAndLoadIntoInterpreter();
        demoWorkspace.addChangeListener(function (event) {
            if (!(event instanceof Blockly.Events.Ui)) {
                // Something changed. Parser needs to be reloaded.
                resetInterpreter();
                generateCodeAndLoadIntoInterpreter();
            }
        });
    </script>
</body>
</html>
